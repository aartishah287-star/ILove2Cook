name: Build Android APK

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-apk:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '11'

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: 'stable'

      - name: Create Flutter project if missing
        if: always()
        run: |
          if [ ! -f pubspec.yaml ]; then
            echo "No pubspec.yaml found — creating Flutter project"
            flutter create .
          else
            echo "pubspec.yaml found — skipping flutter create"
          fi

      - name: Install dependencies
        run: flutter pub get

      - name: Show Flutter environment
        run: flutter doctor -v || true

      - name: Generate launcher icons (if asset present)
        run: |
          if [ -f assets/logo.svg ]; then
            echo "Generating launcher icons from assets/logo.svg"
            flutter pub run flutter_launcher_icons:main || true
          else
            echo "No assets/logo.svg found — skipping launcher icon generation"
          fi

      - name: Configure release signing (if secrets provided)
        if: secrets.ANDROID_KEYSTORE != ''
        run: |
          echo "Configuring keystore from secrets"
          mkdir -p android/app
          echo "$ANDROID_KEYSTORE" | base64 -d > android/app/upload-keystore.jks
          cat > android/key.properties << 'EOF'
          storePassword=${KEYSTORE_PASSWORD}
          keyPassword=${KEY_PASSWORD}
          keyAlias=${KEY_ALIAS}
          storeFile=upload-keystore.jks
          EOF

          # Patch android/app/build.gradle to load key properties and use signing config
          BUILD_FILE=android/app/build.gradle
          if ! grep -q "keyProperties.load" "$BUILD_FILE"; then
            echo "Patching $BUILD_FILE to add keyProperties loader"
            sed -i "1s;^;def keyProperties = new Properties()\ndef keyPropertiesFile = file('../key.properties')\nif (keyPropertiesFile.exists()) {\n    keyPropertiesFile.withInputStream { stream -> keyProperties.load(stream) }\n}\n\n;" "$BUILD_FILE"
          fi

          if ! grep -q "signingConfigs.release" "$BUILD_FILE"; then
            echo "Inserting signingConfigs and wiring release signing"
            awk 'BEGIN{inserted=0} /buildTypes \{/ && !inserted{print "    signingConfigs {";print "        release {";print "            storeFile file('upload-keystore.jks')";print "            storePassword keyProperties['storePassword']";print "            keyAlias keyProperties['keyAlias']";print "            keyPassword keyProperties['keyPassword']";print "        }";print "    }"; inserted=1} {print}' "$BUILD_FILE" > /tmp/build.gradle && mv /tmp/build.gradle "$BUILD_FILE"

            # Ensure release build type references the signingConfig
            awk 'BEGIN{patched=0} /release \{/ {print; while(getline){print; if($0 ~ /minifyEnabled|signingConfig/){ } if($0 ~ /}/){ if(!patched){print "            signingConfig signingConfigs.release"; patched=1} break}} next} {print}' "$BUILD_FILE" > /tmp/build2.gradle || true
            # Fallback: append signingConfig to buildTypes/release if awk failed
            if ! grep -q "signingConfig signingConfigs.release" "$BUILD_FILE"; then
              perl -0777 -pe "s/(buildTypes \{[\s\S]*?release \{[\s\S]*?)(\n\s*\})/\1\n            signingConfig signingConfigs.release\n\2/" -i "$BUILD_FILE" || true
            fi
          fi


      - name: Build APK (release)
        run: flutter build apk --release --no-shrink

      - name: Build APK (debug)
        run: flutter build apk --debug

      - name: Build AAB (release)
        run: flutter build appbundle --release || true

      - name: Upload APK/AAB artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android-builds
          path: |
            build/app/outputs/flutter-apk/*.apk
            build/app/outputs/bundle/release/*.aab
